# {{ ansible_managed }}
#

user			www-data;
worker_processes  	auto;
timer_resolution 	100ms;
pid			/var/run/nginx.pid;

events {
	use                       epoll;
	worker_connections        2048;
}

http {
    	passenger_root 				/usr/local/lib/ruby/gems/2.0.0/gems/passenger-4.0.0.rc6;
    	passenger_ruby 				/usr/local/bin/ruby;
	passenger_show_version_in_header	off;

    	include       			/etc/nginx/mime.types;
    	default_type  			application/octet-stream;
	server_names_hash_bucket_size	64;
	client_max_body_size		5M;
	client_body_buffer_size   	128k;

    	sendfile        		on;
    	tcp_nopush     			on;
	tcp_nodelay			on;
    	keepalive_timeout  		70;
	gzip_static			on;
	gzip				on;

	access_log			/var/log/nginx/access.log;
	error_log			/var/log/nginx/error.log;

	include				/etc/nginx/conf.d/*.conf;
	include				/etc/nginx/sites-enabled/*;

	# our default, HTTPS server
	server {
    		listen   		[::]:443 default;
		server_name		www.dedigitaletopschool.nl;

		root			/web/www.dedigitaletopschool.nl/current/public;
		passenger_enabled	on;

		ssl 			on;
		ssl_certificate		../cert/www.dedigitaletopschool.nl.crt;
		ssl_certificate_key	../cert/www.dedigitaletopschool.nl.key;

		ssl_ciphers			RC4:HIGH:!aNULL:!MD5;
		ssl_prefer_server_ciphers	on;
		ssl_session_timeout		10m;
		ssl_session_cache		shared:SSL:10m;

		location ~ ^/(assets|system)/ {
			expires		1y;
			add_header	Cache-Control public;
			add_header	ETag "";
			break;
		}

		location ~ \.php$ {
			return 404;
		}

	}

	# redirect everything else away
	server {
		listen			[::]:80;
		server_name		dedigitaletopschool.nl www.dedigitaletopschool.nl digitaletopschool.nl www.digitaletopschool.nl;
		return			301 https://www.dedigitaletopschool.nl$request_uri;
	}

	# staging
	server {
		listen			[::]:80;
		server_name  		staging.dedigitaletopschool.nl;
		root			/web/staging.dedigitaletopschool.nl/current/public;
		passenger_enabled	on;
		rails_env		staging;

		location / {
			passenger_enabled on;
			auth_basic "Staging";
			auth_basic_user_file htpasswd;
		}
	}

}
